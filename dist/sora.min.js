/*!
 * sora-js-sdk
 * WebRTC SFU Sora Signaling Library
 * @version: 1.9.0
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("Sora",[],n):"object"==typeof exports?exports.Sora=n():e.Sora=n()}(this,function(){return function(e){var n={};function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=1)}([function(e,n,t){"use strict";var i=t(3);function r(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){return function i(r,o){try{var c=n[r](o),s=c.value}catch(e){return void t(e)}if(!c.done)return Promise.resolve(s).then(function(e){i("next",e)},function(e){i("throw",e)});e(s)}("next")})}}const o=window.RTCPeerConnection,c=window.RTCSessionDescription;n.a=class{constructor(e,n,t,i,r){this.channelId=n,this.metadata=t,this.signalingUrl=e,this.options=i,this.constraints=null,this.debug=r,this.clientId=null,this.remoteClientIds=[],this.stream=null,this.role=null,this._ws=null,this._pc=null,this._callbacks={disconnect:function(){},push:function(){},addstream:function(){},removestream:function(){},notify:function(){},log:function(){}},this.authMetadata=null}on(e,n){e in this._callbacks&&(this._callbacks[e]=n)}disconnect(){var e=this;return r(function*(){e.clientId=null,e.authMetadata=null,e.remoteClientIds=[];const n=new Promise(function(n,t){return e.stream?(e.stream.getTracks().forEach(function(e){e.stop()}),e.stream=null,n()):n()}),t=new Promise(function(n,t){if(!e._ws)return n();e._ws.onclose=function(){};let i=5;const r=setInterval(function(){return e._ws?3===e._ws.readyState?(e._ws=null,clearInterval(r),n()):--i<0?(clearInterval(r),t("WebSocket Closing Error")):void 0:(clearInterval(r),t("WebSocket Closing Error"))},1e3);e._ws.close()}),r=new Promise(function(n,t){if(Object(i.b)()&&e._pc)return e._pc.oniceconnectionstatechange=null,e._pc.close(),e._pc=null,n();if(!e._pc||"closed"===e._pc.signalingState)return n();let r=5;const o=setInterval(function(){return e._pc?"closed"===e._pc.signalingState?(clearInterval(o),e._pc.oniceconnectionstatechange=null,e._pc=null,n()):--r<0?(clearInterval(o),t("PeerConnection Closing Error")):void 0:(clearInterval(o),t("PeerConnection Closing Error"))},1e3);e._pc.close()});return Promise.all([n,t,r])})()}_signaling(e){var n=this;return r(function*(){return n._trace("CREATE OFFER SDP",e),new Promise(function(t,r){null===n._ws&&(n._ws=new WebSocket(n.signalingUrl)),n._ws.onclose=function(e){r(e)},n._ws.onopen=function(){const t=Object(i.a)(e.sdp,n.role,n.channelId,n.metadata,n.options);n._trace("SIGNALING CONNECT MESSAGE",t),n._ws.send(JSON.stringify(t))},n._ws.onmessage=function(e){const i=JSON.parse(e.data);"offer"==i.type?(n.clientId=i.client_id,n._ws.onclose=function(e){n.disconnect().then(function(){n._callbacks.disconnect(e)})},n._ws.onerror=null,"metadata"in i&&(n.authMetadata=i.metadata),n._trace("SIGNALING OFFER MESSAGE",i),n._trace("OFFER SDP",i.sdp),t(i)):"re-offer"==i.type?(n._trace("RE-OFFER SDP",i.sdp),n._reOffer(i)):"ping"==i.type?n._ws.send(JSON.stringify({type:"pong"})):"push"==i.type?n._callbacks.push(i):"notify"==i.type&&n._callbacks.notify(i)}})})()}_createOffer(){return r(function*(){let e={iceServers:[]};Object(i.c)()&&(e=Object.assign({},e,{sdpSemantics:"unified-plan"}));const n=new o(e);let t;return Object(i.b)()?(n.addTransceiver("video").setDirection("recvonly"),n.addTransceiver("audio").setDirection("recvonly"),t=yield n.createOffer()):t=yield n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),n.close(),Promise.resolve(t)})()}_connectPeerConnection(e){var n=this;return r(function*(){if(e.config||(e.config={}),void 0===o.generateCertificate)Object(i.c)()&&(e.config=Object.assign(e.config,{sdpSemantics:"unified-plan"})),n._trace("PEER CONNECTION CONFIG",e.config),n._pc=new o(e.config,n.constraints),n._pc.oniceconnectionstatechange=function(e){n._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",n._pc.iceConnectionState)};else{const t=yield o.generateCertificate({name:"ECDSA",namedCurve:"P-256"});e.config.certificates=[t],Object(i.c)()&&(e.config=Object.assign(e.config,{sdpSemantics:"unified-plan"})),n._trace("PEER CONNECTION CONFIG",e.config),n._pc=new o(e.config,n.constraints),n._pc.oniceconnectionstatechange=function(e){n._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",n._pc.iceConnectionState)}}return Promise.resolve(e)})()}_setRemoteDescription(e){var n=this;return r(function*(){return n._pc.setRemoteDescription(new c({type:"offer",sdp:e.sdp}))})()}_createAnswer(){var e=this;return r(function*(){const n=yield e._pc.createAnswer();return e._pc.setLocalDescription(n)})()}_sendAnswer(){var e=this;return r(function*(){return e._trace("ANSWER SDP",e._pc.localDescription.sdp),e._ws.send(JSON.stringify({type:"answer",sdp:e._pc.localDescription.sdp})),Promise.resolve()})()}_sendReAnswer(){var e=this;return r(function*(){return e._trace("ANSWER SDP",e._pc.localDescription.sdp),e._ws.send(JSON.stringify({type:"re-answer",sdp:e._pc.localDescription.sdp})),Promise.resolve()})()}_onIceCandidate(){var e=this;return r(function*(){return new Promise(function(n,t){const i=setInterval(function(){if(null===e._pc){clearInterval(i);const e=new Error;e.message="ICECANDIDATE TIMEOUT",t(e)}else e._pc&&"connected"===e._pc.iceConnectionState&&(clearInterval(i),n())},100);e._pc.onicecandidate=function(t){if(e._trace("ONICECANDIDATE ICEGATHERINGSTATE",e._pc.iceGatheringState),null===t.candidate)clearInterval(i),n();else{const n=t.candidate.toJSON();n.type="candidate",e._trace("ONICECANDIDATE CANDIDATE MESSAGE",n),e._ws.send(JSON.stringify(n))}}})})()}_reOffer(e){var n=this;return r(function*(){return yield n._setRemoteDescription(e),yield n._createAnswer.bind(n),yield n._sendReAnswer.bind(n),Promise.resolve()})()}_trace(e,n){this._callbacks.log(e,n),this.debug&&Object(i.d)(this.clientId,e,n)}}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),t.d(n,"connection",function(){return o});var i=t(2),r=t(4);const o=function(e,n=!1){return new class{constructor(e,n=!1){this.signalingUrl=e,this.debug=n}publisher(e,n,t={audio:!0,video:!0}){return new i.a(this.signalingUrl,e,n,t,this.debug)}subscriber(e,n,t={audio:!0,video:!0}){return new r.a(this.signalingUrl,e,n,t,this.debug)}}(e,n)}},function(e,n,t){"use strict";var i=t(0);function r(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){return function i(r,o){try{var c=n[r](o),s=c.value}catch(e){return void t(e)}if(!c.done)return Promise.resolve(s).then(function(e){i("next",e)},function(e){i("throw",e)});e(s)}("next")})}}n.a=class extends i.a{connect(e){return this.role="upstream",this.options&&this.options.multistream?this._multiStream(e):this._singleStream(e)}_singleStream(e){var n=this;return r(function*(){yield n.disconnect();const t=yield n._createOffer(),i=yield n._signaling(t),r=yield n._connectPeerConnection(i);return void 0===n._pc.addStream?e.getTracks().forEach(function(t){n._pc.addTrack(t,e)}):n._pc.addStream(e),n.stream=e,yield n._setRemoteDescription(r),yield n._createAnswer(),yield n._sendAnswer(),yield n._onIceCandidate(),Promise.resolve(e)})()}_multiStream(e){var n=this;return r(function*(){yield n.disconnect();const t=yield n._createOffer(),i=yield n._signaling(t),r=yield n._connectPeerConnection(i);return void 0===n._pc.addStream?e.getTracks().forEach(function(t){n._pc.addTrack(t,e)}):n._pc.addStream(e),void 0===n._pc.ontrack?n._pc.onaddstream=function(t){n.clientId!==t.stream.id&&(n.remoteClientIds.push(e.id),n._callbacks.addstream(t))}:n._pc.ontrack=function(e){const t=e.streams[0];t&&"default"!==t.id&&t.id!==n.clientId&&(-1<n.remoteClientIds.indexOf(t.id)||(e.stream=t,n.remoteClientIds.push(t.id),n._callbacks.addstream(e)))},n._pc.onremovestream=function(e){const t=n.remoteClientIds.indexOf(e.stream.id);-1<t&&delete n.remoteClientIds[t],n._callbacks.removestream(e)},n.stream=e,yield n._setRemoteDescription(r),yield n._createAnswer(),yield n._sendAnswer(),yield n._onIceCandidate(),Promise.resolve(e)})()}}},function(e,n,t){"use strict";function i(){const e=window.navigator.userAgent.toLocaleLowerCase();return-1!==e.indexOf("chrome")?"chrome":-1!==e.indexOf("edge")?"edge":-1!==e.indexOf("firefox")?"firefox":-1!==e.indexOf("safari")?"safari":void 0}function r(){if("chrome"!==i())return!1;const e=window.navigator.userAgent.toLocaleLowerCase(),n=/chrome\/([\d.]+)/.exec(e);return!(!n||n.length<2)&&70<=parseInt(n[1])}n.d=function(e,n,t){let r="";window.performance&&(r="["+(window.performance.now()/1e3).toFixed(3)+"]");e&&(r=r+"["+e+"]");"edge"===i()?console.log(r+" "+n+"\n",t):console.info(r+" "+n+"\n",t)},n.c=r,n.b=function(){return"safari"===i()},n.a=function(e,n,t,o,c){const s={type:"connect",role:n,channel_id:t,metadata:o,sdp:e,userAgent:window.navigator.userAgent,audio:!0,video:!0};Object.keys(s).forEach(e=>{void 0===s[e]&&(s[e]=null)}),"multistream"in c&&!0===c.multistream&&(s.multistream=!0,r()||"chrome"!==i()&&"safari"!==i()||(s.plan_b=!0));"spotlight"in c&&(s.spotlight=c.spotlight);const a=["audioCodecType","audioBitRate"],d=["videoCodecType","videoBitRate"],l=Object.assign({},c);Object.keys(l).forEach(e=>{"audio"===e&&"boolean"==typeof l[e]||"video"===e&&"boolean"==typeof l[e]||0<=a.indexOf(e)&&null!==l[e]||0<=d.indexOf(e)&&null!==l[e]||delete l[e]}),"audio"in l&&(s.audio=l.audio);const u=Object.keys(l).some(e=>0<=a.indexOf(e));s.audio&&u&&(s.audio={},"audioCodecType"in l&&(s.audio.codec_type=l.audioCodecType),"audioBitRate"in l&&(s.audio.bit_rate=l.audioBitRate));"video"in l&&(s.video=l.video);const f=Object.keys(l).some(e=>0<=d.indexOf(e));s.video&&f&&(s.video={},"videoCodecType"in l&&(s.video.codec_type=l.videoCodecType),"videoBitRate"in l&&(s.video.bit_rate=l.videoBitRate));return s}},function(e,n,t){"use strict";var i=t(0);function r(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){return function i(r,o){try{var c=n[r](o),s=c.value}catch(e){return void t(e)}if(!c.done)return Promise.resolve(s).then(function(e){i("next",e)},function(e){i("throw",e)});e(s)}("next")})}}n.a=class extends i.a{connect(){return this.role="downstream",this.options&&this.options.multistream?this._multiStream():this._singleStream()}_singleStream(){var e=this;return r(function*(){yield e.disconnect();const n=yield e._createOffer(),t=yield e._signaling(n),i=yield e._connectPeerConnection(t);return void 0===e._pc.ontrack?e._pc.onaddstream=function(e){this.stream=e.stream}.bind(e):e._pc.ontrack=function(e){this.stream=e.streams[0]}.bind(e),yield e._setRemoteDescription(i),yield e._createAnswer(),yield e._sendAnswer(),yield e._onIceCandidate(),Promise.resolve(e.stream)})()}_multiStream(){var e=this;return r(function*(){yield e.disconnect();const n=yield e._createOffer(),t=yield e._signaling(n),i=yield e._connectPeerConnection(t);return void 0===e._pc.ontrack?e._pc.onaddstream=function(n){e.remoteClientIds.push(n.id),e._callbacks.addstream(n)}:e._pc.ontrack=function(n){const t=n.streams[0];"default"!==t.id&&t.id!==e.clientId&&(-1<e.remoteClientIds.indexOf(t.id)||(n.stream=t,e.remoteClientIds.push(t.id),e._callbacks.addstream(n)))},e._pc.onremovestream=function(n){const t=e.remoteClientIds.indexOf(n.stream.id);-1<t&&delete e.remoteClientIds[t],e._callbacks.removestream(n)},yield e._setRemoteDescription(i),yield e._createAnswer(),yield e._sendAnswer(),yield e._onIceCandidate(),Promise.resolve()})()}}}])});